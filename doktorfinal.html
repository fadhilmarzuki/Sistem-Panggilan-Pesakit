<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <title>Panel Stesen - Kawalan Penuh</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 550px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        select, input, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        .btn-next { background: #27ae60; color: white; border: none; font-weight: bold; cursor: pointer; height: 60px; font-size: 20px; }
        .btn-recall { background: #e67e22; color: white; border: none; font-weight: bold; cursor: pointer; height: 50px; margin: 10px 0; }
        .btn-back { background: #f1f2f6; color: #7f8c8d; border: 1px solid #ddd; font-weight: bold; height: 50px; }
        .display-area { background: #2c3e50; color: white; padding: 20px; border-radius: 12px; margin-top: 20px; text-align: center; }
        .curr-num { font-size: 60px; font-weight: 900; color: #f1c40f; }
        .waiting-stat { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        #serviceLabel { padding: 5px 15px; border-radius: 20px; font-size: 14px; display: inline-block; font-weight: bold; background: #e74c3c; }
    </style>
</head>
<body>

<div class="container">
    <div id="liveClock" style="text-align:center; font-weight:bold; color:#7f8c8d; margin-bottom:10px;"></div>
    <div class="card">
        <h2>Konfigurasi Stesen</h2>
        <label>Bilik / Stesen Anda:</label><select id="selectRoom"></select>
        <label>Perkhidmatan Dipantau:</label><select id="selectService"><option value="PELBAGAI">-- PELBAGAI --</option></select>
    </div>

    <div class="card" style="text-align: center;">
        <div class="display-area">
            <div class="waiting-stat">Baki Menunggu: <span id="waitingCount" style="color:#55efc4">0</span></div>
            <div id="roomLabel" style="font-size:18px; opacity:0.8;">-- Sedia --</div>
            <div class="curr-num" id="displayNum">---</div>
            <div id="serviceLabel">Sedia</div>
        </div>
        <div style="margin-top: 20px;">
            <button class="btn-next" onclick="callNext()">PESAKIT SETERUSNYA</button>
            <button class="btn-recall" onclick="recallPatient()">PANGGIL SEMULA</button>
            <button class="btn-back" onclick="undoCall()">BACK</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyBRK634U8ER_ZFOi1SV9nu8McndUWdD-rg", databaseURL: "https://sistem-panggilan-pelanggan-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let session = { current: null, service: null };

    setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleString('ms-MY'); }, 1000);

    db.ref('queue_system/settings').on('value', snap => {
        const s = snap.val(); if(!s) return;
        const rS = document.getElementById('selectRoom'), sS = document.getElementById('selectService');
        const currentR = rS.value, currentS = sS.value;
        rS.innerHTML = '<option value="">-- Pilih Bilik --</option>'; sS.innerHTML = '<option value="PELBAGAI">-- PELBAGAI --</option>';
        (s.rooms || []).forEach(r => { if(r) rS.innerHTML += `<option value="${r}">${r}</option>`; });
        (s.services || []).forEach(sv => { if(sv.name) sS.innerHTML += `<option value="${sv.name}">${sv.name}</option>`; });
        rS.value = currentR; sS.value = currentS;
    });

    function updateWaitingCount() {
        const sel = document.getElementById('selectService').value;
        db.ref('queue_system/waiting_list').orderByChild('status').equalTo('waiting').on('value', snap => {
            let count = 0; snap.forEach(c => { if(sel === "PELBAGAI" || c.val().service === sel) count++; });
            document.getElementById('waitingCount').innerText = count;
        });
    }
    document.getElementById('selectService').addEventListener('change', updateWaitingCount);

    function callNext() {
        const sR = document.getElementById('selectRoom').value, sS = document.getElementById('selectService').value;
        if(!sR) return alert("Sila pilih bilik!");
        db.ref('queue_system/waiting_list').orderByChild('status').equalTo('waiting').once('value', snap => {
            let found = false;
            snap.forEach(child => {
                const p = child.val(); if((sS === "PELBAGAI" || p.service === sS) && !found) {
                    found = true; session.current = child.key; session.service = p.service;
                    const now = Date.now();
                    db.ref('queue_system/waiting_time_logs').push({ number: child.key, ic: p.ic || "N/A", service: p.service, room: sR, reg_timestamp: p.timestamp, call_timestamp: now });
                    db.ref('queue_system/waiting_list/'+child.key).update({ status: 'called', calledBy: sR });
                    db.ref('queue_system/current_calling').set({ number: child.key, room: sR, service: p.service, time: now });
                    document.getElementById('displayNum').innerText = child.key;
                    document.getElementById('roomLabel').innerText = sR;
                    document.getElementById('serviceLabel').innerText = p.service;
                }
            });
            if(!found) alert("Tiada pesakit.");
        });
    }

    function recallPatient() { if(!session.current) return; db.ref('queue_system/current_calling').update({ time: Date.now() }); }
    function undoCall() { if(!session.current) return; db.ref('queue_system/waiting_list/'+session.current).update({ status: 'waiting' }); location.reload(); }
</script>
</body>
</html>
