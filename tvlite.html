<!DOCTYPE html>
<html lang="ms">

<head>
    <meta charset="UTF-8">
    <title>Paparan TV - KK BAS (Classic Lite)</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial Black', sans-serif;
            background: #2c3e50;
            overflow: hidden;
            color: white;
        }

        .header-container {
            display: flex;
            height: 15vh;
            border-bottom: 5px solid #fff;
        }

        .main-container {
            display: flex;
            height: 75vh;
        }

        .footer-container {
            height: 10vh;
            background: #1a73e8;
            display: flex;
            align-items: center;
            overflow: hidden;
            border-top: 5px solid #fff;
            position: relative;
            z-index: 10;
        }

        .header-left {
            width: 70%;
            background: #1a73e8;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 5px solid #fff;
            padding: 10px 30px;
            text-align: center;
        }

        #clinicName {
            font-size: clamp(30px, 4vw, 55px);
            line-height: 1.1;
            display: block;
            width: 100%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .header-right {
            width: 30%;
            background: #e74c3c;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* REVISION: Expanded current call area (70% width) */
        .call-section {
            width: 70%;
            background: #000;
            border-right: 5px solid #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .label-now {
            font-size: clamp(20px, 4vmin, 40px);
            color: #e74c3c;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .num-now {
            font-size: clamp(100px, 20vw, 280px);
            /* Super big since no video */
            font-weight: 900;
            color: #fff;
            line-height: 1;
            text-shadow: 0 0 40px rgba(255, 255, 255, 0.4);
        }

        .room-now {
            font-size: clamp(30px, 8vmin, 80px);
            font-weight: bold;
            color: #1a73e8;
            background: #fff;
            padding: 1.5vh 5vw;
            border-radius: 20px;
            margin-top: 30px;
            text-transform: uppercase;
        }

        /* RIGHT SECTION: History (30% width) */
        .queue-section {
            width: 30%;
            background: #fff;
            color: #2c3e50;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .history-section {
            height: 100%;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .history-title {
            text-align: center;
            font-size: clamp(14px, 1.5vw, 20px);
            font-weight: 900;
            color: #7f8c8d;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;
            text-transform: uppercase;
        }

        .history-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            flex-grow: 1;
            align-content: start;
            overflow: hidden;
        }

        .history-item {
            background: #f8f9fa;
            border: 2px solid #e1e4e8;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            height: 90px;
        }

        .h-num {
            font-size: clamp(25px, 4vmin, 45px);
            font-weight: 900;
            color: #2c3e50;
        }

        .h-room {
            font-size: clamp(12px, 1.5vmin, 18px);
            color: #1a73e8;
            font-weight: bold;
            text-transform: uppercase;
            background: rgba(26, 115, 232, 0.1);
            padding: 5px 15px;
            border-radius: 8px;
        }

        #tvTime {
            font-size: clamp(20px, 3.5vmin, 38px);
            font-weight: bold;
        }

        #tvDate {
            font-size: clamp(12px, 1.5vmin, 18px);
            opacity: 0.9;
        }

        .marquee {
            white-space: nowrap;
            font-size: clamp(20px, 3.5vh, 35px);
            animation: marquee 25s linear infinite;
            padding-left: 100%;
            font-weight: bold;
        }

        @keyframes marquee {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-100%, 0);
            }
        }

        #overlay {
            position: fixed;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #startBtn {
            padding: 30px 60px;
            font-size: 35px;
            cursor: pointer;
            background: #27ae60;
            color: white;
            border: 5px solid white;
            border-radius: 20px;
            outline: none;
            transition: 0.3s;
        }

        #startBtn:focus {
            transform: scale(1.1);
            background: #2ecc71;
            box-shadow: 0 0 30px #27ae60;
        }

        .blink {
            animation: blinker 0.6s linear 5;
        }

        @keyframes blinker {
            50% {
                opacity: 0.1;
                background-color: #e74c3c;
            }
        }
    </style>
</head>

<body>

    <div id="overlay">
        <h1 style="color:white; margin-bottom:10px;">SISTEM PANGGILAN PESAKIT</h1>
        <p style="color:white; opacity:0.8; margin-bottom:30px;">Tekan butang 'OK' atau 'ENTER' pada remote untuk mula
        </p>
        <button id="startBtn" onclick="initTV()" autofocus>MULA PAPARAN TV</button>
    </div>

    <div class="header-container">
        <div class="header-left">
            <div id="clinicName">KK BAS</div>
        </div>
        <div class="header-right">
            <div id="tvTime">00:00:00</div>
            <div id="tvDate">Memuatkan...</div>
            <div id="statusDot"
                style="width:10px; height:10px; background:red; border-radius:50%; margin-top:5px; border:1px solid white;">
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="call-section" id="callCard">
            <div class="label-now">PANGGILAN SEKARANG</div>
            <div id="tvNum" class="num-now">---</div>
            <div id="tvRoom" class="room-now">SEDIA</div>
        </div>
        <div class="queue-section">
            <div class="history-section">
                <div class="history-title">GILIRAN SEBELUM INI</div>
                <div id="historyGrid" class="history-grid"></div>
            </div>
        </div>
    </div>

    <div class="footer-container">
        <div class="marquee" id="tvMarquee">Selamat Datang ke Klinik Kesihatan.</div>
    </div>

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBRK634U8ER_ZFOi1SV9nu8McndUWdD-rg",
            databaseURL: "https://sistem-panggilan-pelanggan-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let malayVoice, systemReady = false;

        window.onload = function () {
            document.getElementById('startBtn').focus();
        };

        window.addEventListener('keydown', function (e) {
            if (!systemReady) initTV();
        });

        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            malayVoice = voices.find(v =>
                v.lang.includes('ms-MY') ||
                v.name.includes('Zira') ||
                v.name.includes('Google Bahasa Melayu') ||
                v.lang.includes('id-ID')
            );
        }
        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        function toMalayWords(text, spellOut = true) {
            const map = {
                '0': 'kosong', '1': 'satu', '2': 'dua', '3': 'tiga', '4': 'empat',
                '5': 'lima', '6': 'enam', '7': 'tujuh', '8': 'lapan', '9': 'sembilan'
            };
            if (spellOut) {
                let chars = text.toString().split('');
                return chars.map((char, index) => {
                    let word = map[char] || char;
                    return (index === 0 && isNaN(char)) ? word + ' , ' : word;
                }).join(' ');
            } else {
                return text.toString().toLowerCase().replace(/[0-9]/g, (digit) => ' ' + map[digit] + ' ');
            }
        }

        function announce(num, room) {
            if (!systemReady) return;

            const malayNum = toMalayWords(num, true);
            const malayRoom = toMalayWords(room, false);
            const msg = new SpeechSynthesisUtterance(`Nombor, ${malayNum}. Sila ke ${malayRoom}.`);

            if (malayVoice) {
                msg.voice = malayVoice;
                msg.lang = malayVoice.lang;
            } else {
                msg.lang = 'ms-MY';
            }

            msg.rate = 0.85;
            window.speechSynthesis.speak(msg);
        }

        function playAlert() {
            const sound = document.getElementById('alertSound');
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Audio trigger blocked"));
            }
        }

        function fitClinicName() {
            const parent = document.querySelector('.header-left');
            const child = document.getElementById('clinicName');
            if (!parent || !child) return;
            let fontSize = 55; child.style.fontSize = fontSize + "px";
            while ((child.scrollHeight > parent.clientHeight - 20 || child.scrollWidth > parent.clientWidth - 60) && fontSize > 25) {
                fontSize--; child.style.fontSize = fontSize + "px";
            }
        }

        function initTV() {
            if (systemReady) return;
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('statusDot').style.background = '#27ae60'; // Green = Ready
            systemReady = true;

            const warmup = new SpeechSynthesisUtterance("");
            window.speechSynthesis.speak(warmup);
            playAlert();
        }

        db.ref('queue_system/settings').on('value', snap => {
            const s = snap.val();
            if (s) {
                document.getElementById('clinicName').innerText = (s.clinic_name || "KK BAS").toUpperCase();
                setTimeout(fitClinicName, 100);
                document.getElementById('tvMarquee').innerText = s.message || "Selamat Datang...";
            }
        });

        db.ref('queue_system/test_trigger').on('value', snap => {
            if (systemReady) playAlert();
        });

        db.ref('queue_system/current_calling').on('value', snap => {
            const d = snap.val();
            if (!d) return;

            // Sentiasa kemaskini teks di skrin
            document.getElementById('tvNum').innerText = d.number;
            document.getElementById('tvRoom').innerText = d.room;

            if (systemReady && d.number !== "---") {
                // Trigger Animasi Berkelip
                const card = document.getElementById('callCard');
                if (card) {
                    card.classList.remove('blink');
                    void card.offsetWidth;
                    card.classList.add('blink');
                }

                // Trigger Suara & Alert
                playAlert();
                setTimeout(() => announce(d.number, d.room), 1000);
            }
        });

        db.ref('queue_system/waiting_list').on('value', snap => {
            const list = snap.val(); if (!list) return;
            const historyData = Object.keys(list)
                .map(k => ({ number: k, ...list[k] }))
                .filter(i => i.status === 'called')
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 6);

            const grid = document.getElementById('historyGrid');
            if (grid) {
                grid.innerHTML = "";
                historyData.forEach(i => {
                    grid.innerHTML += `<div class="history-item">
                        <div class="h-num">${i.number}</div>
                        <div class="h-room">${i.calledBy || 'Bilik'}</div>
                    </div>`;
                });
            }
        });

        function updateClock() {
            const now = new Date();
            const timeEl = document.getElementById('tvTime');
            const dateEl = document.getElementById('tvDate');
            if (timeEl) timeEl.innerText = now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }).toUpperCase();
            if (dateEl) dateEl.innerText = now.toLocaleDateString('ms-MY', { weekday: 'short', day: 'numeric', month: 'short' });
        }
        setInterval(updateClock, 1000);
        updateClock();
    </script>
</body>

</html>
